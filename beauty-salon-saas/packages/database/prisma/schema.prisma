// Prisma schema for Beauty Salon SaaS
// Multi-tenant architecture with Row-Level Security (RLS)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_DIRECT_URL")
}

// ========================================
// TENANTS (РЎР°Р»РѕРЅС‹)
// ========================================

model Tenant {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  subdomain String   @unique
  timezone  String   @default("UTC")
  currency  String   @default("USD")
  language  String   @default("ru")
  settings  Json?    @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  staff                     Staff[]
  services                  Service[]
  serviceDurationOverrides  ServiceDurationOverride[]
  clients                   Client[]
  appointments              Appointment[]
  messageLogs               MessageLog[]
  aiDecisions               AiDecision[]
  cases                     Case[]

  @@map("tenants")
}

// ========================================
// STAFF (РњР°СЃС‚РµСЂР°)
// ========================================

model Staff {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  name      String
  email     String?
  phone     String?
  role      StaffRole
  skills    Json?    @db.JsonB
  avatar    String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant                   Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  serviceDurationOverrides ServiceDurationOverride[]
  appointments             Appointment[]
  assignedCases            Case[]

  @@unique([tenantId, email])
  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([tenantId, active])
  @@map("staff")
}

enum StaffRole {
  owner
  admin
  staff
}

// ========================================
// SERVICES (РЈСЃР»СѓРіРё)
// ========================================

model Service {
  id                   String   @id @default(uuid()) @db.Uuid
  tenantId             String   @map("tenant_id") @db.Uuid
  name                 String
  description          String?
  baseDurationMinutes  Int      @map("base_duration_minutes")
  price                Decimal  @db.Decimal(10, 2)
  currency             String   @default("USD")
  category             String?
  active               Boolean  @default(true)
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant                   Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  serviceDurationOverrides ServiceDurationOverride[]
  appointments             Appointment[]

  @@index([tenantId])
  @@index([tenantId, active])
  @@map("services")
}

// ========================================
// SERVICE DURATION OVERRIDES (Р”Р»РёС‚РµР»СЊРЅРѕСЃС‚СЊ РїРѕ РјР°СЃС‚РµСЂСѓ)
// ========================================

model ServiceDurationOverride {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  serviceId       String   @map("service_id") @db.Uuid
  staffId         String   @map("staff_id") @db.Uuid
  durationMinutes Int      @map("duration_minutes")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  staff   Staff   @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([tenantId, serviceId, staffId])
  @@index([tenantId])
  @@map("service_duration_overrides")
}

// ========================================
// CLIENTS (РљР»РёРµРЅС‚С‹)
// ========================================

model Client {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  phone        String
  name         String?
  email        String?
  channels     Json?    @db.JsonB // {telegram_id, whatsapp_id, ...}
  tags         String[]
  vip          Boolean  @default(false)
  stopList     Boolean  @default(false) @map("stop_list")
  bonusBalance Int      @default(0) @map("bonus_balance")
  metadata     Json?    @db.JsonB
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  messageLogs  MessageLog[]
  aiDecisions  AiDecision[]
  cases        Case[]

  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([tenantId, phone])
  @@index([tenantId, vip])
  @@index([tenantId, updatedAt])
  @@map("clients")
}

// ========================================
// APPOINTMENTS (Р—Р°РїРёСЃРё)
// ========================================

model Appointment {
  id        String            @id @default(uuid()) @db.Uuid
  tenantId  String            @map("tenant_id") @db.Uuid
  clientId  String            @map("client_id") @db.Uuid
  staffId   String            @map("staff_id") @db.Uuid
  serviceId String            @map("service_id") @db.Uuid
  startAt   DateTime          @map("start_at") @db.Timestamptz
  endAt     DateTime          @map("end_at") @db.Timestamptz
  status    AppointmentStatus @default(planned)
  price     Decimal?          @db.Decimal(10, 2)
  paid      Decimal           @default(0) @db.Decimal(10, 2)
  notes     String?
  metadata  Json?             @db.JsonB
  createdAt DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client  Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  staff   Staff   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([tenantId, staffId, startAt])
  @@index([tenantId, startAt])
  @@index([tenantId, status, startAt])
  @@index([tenantId, clientId, startAt])
  @@map("appointments")
}

enum AppointmentStatus {
  planned
  confirmed
  completed
  cancelled
  no_show
  rescheduled
}

// ========================================
// MESSAGE LOG (РџР°СЂС‚РёС†РёРѕРЅРёСЂРѕРІР°РЅРЅР°СЏ С‚Р°Р±Р»РёС†Р°)
// ========================================

model MessageLog {
  id          String      @id @default(uuid()) @db.Uuid
  tenantId    String      @map("tenant_id") @db.Uuid
  clientId    String      @map("client_id") @db.Uuid
  channel     Channel
  direction   Direction
  messageType MessageType @map("message_type")
  content     String?
  metadata    Json?       @db.JsonB
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([tenantId, clientId, createdAt])
  @@index([tenantId, channel, createdAt])
  @@map("message_log")
}

enum Channel {
  telegram
  whatsapp
  instagram
  vk
  max
  web
  mobile
}

enum Direction {
  inbound
  outbound
}

enum MessageType {
  tx // Transactional
  mk // Marketing
  case // Case/Escalation
}

// ========================================
// AI DECISIONS LOG
// ========================================

model AiDecision {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  clientId   String   @map("client_id") @db.Uuid
  agentRole  String   @map("agent_role")
  decision   String
  confidence Float
  escalated  Boolean  @default(false)
  metadata   Json?    @db.JsonB
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([tenantId, escalated])
  @@map("ai_decisions")
}

// ========================================
// CASES (Р­СЃРєР°Р»Р°С†РёРё)
// ========================================

model Case {
  id         String     @id @default(uuid()) @db.Uuid
  tenantId   String     @map("tenant_id") @db.Uuid
  clientId   String     @map("client_id") @db.Uuid
  assignedTo String?    @map("assigned_to") @db.Uuid
  reason     String
  status     CaseStatus @default(open)
  context    Json?      @db.JsonB
  resolution String?
  createdAt  DateTime   @default(now()) @map("created_at") @db.Timestamptz
  resolvedAt DateTime?  @map("resolved_at") @db.Timestamptz
  updatedAt  DateTime   @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant         Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  assignedStaff  Staff? @relation(fields: [assignedTo], references: [id], onDelete: SetNull)

  @@index([tenantId, status])
  @@index([tenantId, assignedTo])
  @@map("cases")
}

enum CaseStatus {
  open
  in_progress
  resolved
  unresolved
}
